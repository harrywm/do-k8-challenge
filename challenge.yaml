apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
        name: es
spec:
        version: 7.15.2
        nodeSets:
        - name: default
          config:
                  node.store.allow_mmap: false
                  node.master: true
                  node.data: true
                  node.ingest: true
                  node.ml: true
          podTemplate:
                metadata:
                        labels:
                                app: es
                spec:
                        initContainers:
                        - name: sysctl
                          securityContext:
                                privileged: true
                          command: ['sh', '-c', 'sysctl -w vm.max_map_count=262144']
                        containers:
                        - name: es
                          resources:
                                  requests:
                                          memory: 2Gi
                                          cpu: 0.5
                                  limits:
                                          memory: 2Gi
                                          cpu: 1
                          env: 
                          - name: ES_JAVA_OPTS
                            value: "-Xms1g Xmx1g"
          count: 2
        http:
                service:
                        spec:
                                type: LoadBalancer

---

apiVersion: kibana.k8s.elastic.co/v1
kind: Kibana
metadata:
        name: es
spec:
        version: 7.15.2
        count: 1
        elasticsearchRef:
                name: es
        secureSettings: 
        - secretName: kibana-saved-objects-encrypted-key
        http:
                service:
                        spec:
                                type: LoadBalancer
                                ports:
                                - name: https
                                  protocol: TCP
                                   port: 443
                                   targetPort: 5601
        podTemplate: 
                metadata: 
                        labels: 
                                app: es
                spec:
                        containers:
                        - name: kb
                          resources:
                                  limits:
                                          memory: 1Gi
                                          cpi: 1
